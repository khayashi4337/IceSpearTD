


```mermaid
graph TD
    A[ゲーム開始] --> B[マップタイプ選択]
    B --> C{マップタイプ}
    C -->|平原| D[平原マップ生成]
    C -->|川| E[川マップ生成]
    C -->|岩山| F[岩山マップ生成]
    D --> G[迷路ベース生成]
    E --> G
    F --> G
    G --> H[マップタイプ別調整]
    H --> I[開始/終了地点設定]
    I --> J[敵の配列初期化]
    J --> K[ウェーブカウンター初期化]
    K --> L{ウェーブ開始?}
    L -->|No| L
    L -->|Yes| M[ウェーブ設定読み込み]
    M --> N[ウェーブタイマー設定]
    N --> O[敵インスタンスの準備]
    O --> P[敵の出撃タイマー設定]
    P --> Q{出撃時間到達?}
    Q -->|No| Q
    Q -->|Yes| R[敵インスタンスを配列に追加]
    R --> S[初期経路計算]
    S --> T[敵の移動処理開始]

    T --> U{全ての敵の処理}
    U --> V[現在位置の取得]
    V --> W[マップ特性に基づく移動速度調整]
    W --> X[次の移動地点の計算]
    X --> Y{障害物/地形変化検出?}
    Y -->|Yes| Z[経路再計算]
    Y -->|No| AA[移動実行]
    Z --> AA
    AA --> AB{ゴールに到達?}
    AB -->|No| AC{マップ上に残存?}
    AB -->|Yes| AD[プレイヤーの体力を減少]
    AD --> AE[敵インスタンスを配列から削除]
    AC -->|Yes| U
    AC -->|No| AE
    AE --> AF{ウェーブ終了条件確認}

    AF --> AG{ウェーブタイマー終了?}
    AF --> AH{予定敵全滅?}
    AG -->|Yes| AI[ウェーブ終了処理]
    AH -->|Yes| AI
    AG -->|No| U
    AH -->|No| U

    AI --> AJ[ウェーブカウンター増加]
    AJ --> AK{全ウェーブクリア?}
    AK -->|No| L
    AK -->|Yes| AL[ゲームクリア]

    AM[ユーザーによる障害物配置] --> AN[全敵の経路再計算をトリガー]
    AN --> U

    AO[プレイヤーの体力が0] --> AP[ゲームオーバー]

    style A fill:#f9f,stroke:#333,stroke-width:2px
    style AL fill:#9f9,stroke:#333,stroke-width:2px
    style AP fill:#f99,stroke:#333,stroke-width:2px

```

この更新されたフローチャートは、マップタイプを考慮に入れた以下の主要なプロセスと考慮事項を表しています：

1. **マップ生成と初期化**:
   - プレイヤーがマップタイプ（平原、川、岩山）を選択します。
   - 選択されたタイプに基づいて迷路ベースのマップを生成します。
   - マップタイプ別の調整を行います（例：平原は通路を増やす、川は水路と橋を追加、岩山は通路を減らす）。
   - 開始地点と終了地点を設定します。

2. **ゲーム初期化**:
   - 敵を格納するための配列を初期化します。
   - ウェーブカウンターを初期化します。

3. **ウェーブ管理**:
   - ウェーブ開始時に、そのウェーブの設定を読み込みます。
   - ウェーブタイマーを設定します。

4. **敵の生成と管理**:
   - 各敵に対して出撃時間を設定し、時間に達したら敵のインスタンスを生成し配列に追加します。
   - 初期経路を計算します。

5. **敵の移動処理**:
   - マップの特性に基づいて移動速度を調整します（例：森林では遅くなる、平地では通常速度）。
   - 障害物や地形変化を検出し、必要に応じて経路を再計算します。

6. **ゴール到達処理**:
   - 敵がゴールに到達した場合、プレイヤーの体力を減少させます。
   - その後、敵のインスタンスを配列から削除します。

7. **ウェーブ終了条件チェック**:
   - ウェーブタイマーが終了したか、または予定されていた全ての敵が倒されたかをチェックします。
   - いずれかの条件が満たされた場合、ウェーブ終了処理に移ります。

8. **ウェーブ終了処理**:
   - ウェーブカウンターを増加させます。
   - 全てのウェーブをクリアしたかチェックし、クリアしていない場合は次のウェーブを開始します。

9. **ゲーム終了条件**:
   - 全ウェーブクリアでゲームクリア。
   - プレイヤーの体力が0になった場合、ゲームオーバー。

このデザインの特徴と利点：

- 異なるマップタイプにより、プレイヤーに多様な戦略的選択肢を提供します。
- マップの特性が敵の移動に影響を与え、より動的で興味深いゲームプレイを実現します。
- ウェーブ制御により、ゲームの難易度を段階的に上げることが可能になります。
- 時間制限と敵の全滅という2つのウェーブ終了条件により、プレイヤーに異なる目標を提供します。

実装時の注意点：

- 各マップタイプの特性をバランス良く設計し、それぞれに独自の戦略が必要になるようにします。
- マップの視覚的表現を工夫し、プレイヤーが直感的に地形の特性を理解できるようにします。
- パフォーマンスに注意を払い、特に複雑なマップや多数の敵が存在する場合の処理を最適化します。
- ユーザーインターフェースで現在のウェーブ情報、残り時間、マップ特性などを明確に表示します。

この設計により、マップタイプの違いを活かした、より戦略的で多様なゲームプレイ体験を提供することができます。
